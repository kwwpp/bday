<html lang="zh-HK"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday Lamy! | ä½›ç³»ï¼Chiikawaï¼é¤Šç”Ÿ</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&amp;family=Lato:wght@300;400;700&amp;display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Html2Canvas Library for Exporting Images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --clay: #d38e6e;
            --clay-dark: #a66045;
            --sage: #8da399;
            --sage-dark: #5f756b;
            --cream: #f9f5f0;
            --gold: #d4af37;
            --text: #4a4a4a;
            --red-stamp: #d9534f;
            --wood: #8b5a2b;
            --incense-ash: #a8a8a8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Lato', 'Noto Serif TC', serif;
            background-color: var(--cream);
            color: var(--text);
            overflow-x: hidden;
            scroll-behavior: smooth;
            line-height: 1.6;
            position: relative;
        }

        /* Background & Canvas */
        .bg-orb { position: fixed; border-radius: 50%; filter: blur(80px); z-index: -1; opacity: 0.4; animation: floatBg 20s infinite alternate; }
        .orb-1 { width: 400px; height: 400px; background: var(--clay); top: -100px; left: -100px; }
        .orb-2 { width: 300px; height: 300px; background: var(--sage); bottom: 10%; right: -50px; animation-delay: -5s; }
        .orb-3 { width: 200px; height: 200px; background: var(--gold); top: 40%; left: 30%; opacity: 0.2; animation-delay: -10s; }
        @keyframes floatBg { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 50px) scale(1.1); } }
        #celebrationCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* Layout */
        h1, h2, h3, h4 { font-family: 'Noto Serif TC', serif; font-weight: 700; }
        nav { position: fixed; top: 0; width: 100%; background: rgba(249, 245, 240, 0.95); padding: 1rem 2rem; z-index: 1000; display: flex; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); backdrop-filter: blur(5px); }
        nav ul { list-style: none; display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; }
        nav a { text-decoration: none; color: var(--text); font-weight: bold; font-size: 0.9rem; transition: color 0.3s; }
        nav a:hover { color: var(--clay); }

        header { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 5rem 2rem 2rem; }
        header h1 { font-size: 3.5rem; color: var(--clay-dark); margin-bottom: 1rem; animation: fadeIn 1.5s ease-out forwards; }
        header p { font-size: 1.4rem; color: var(--sage-dark); font-weight: 400; animation: fadeIn 1.5s ease-out 0.5s forwards; }
        
        /* New Banner Style */
        .banner-img {
            max-width: 100%;
            width: 750px;
            height: auto;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(139, 90, 43, 0.2);
            border: 5px solid white;
            animation: fadeIn 1.5s ease-out forwards;
        }
        
        /* Birthday Song Button */
        .btn-music-player {
            background: var(--gold);
            color: #1a1a1a;
            font-family: 'Noto Serif TC', serif;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 15px 35px;
            border-radius: 50px;
            border: 2px solid #b8860b;
            cursor: pointer;
            margin-top: 35px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
            transition: all 0.3s ease;
            animation: fadeIn 1.5s ease-out 1s forwards, pulseText 2s infinite;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .btn-music-player:hover { transform: scale(1.05); background: #fff; }
        .btn-music-player:active { transform: scale(0.95); }

        @keyframes pulseText { from { transform: scale(1); } to { transform: scale(1.05); } }
        .scroll-down { margin-top: 3rem; font-size: 2rem; color: var(--clay); animation: bounce 2s infinite; cursor: pointer; opacity: 0.7; }

        section { padding: 5rem 2rem; min-height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transform: translateY(50px); transition: opacity 1s ease-out, transform 1s ease-out; }
        section.visible { opacity: 1; transform: translateY(0); }
        .section-title { font-size: 2.2rem; margin-bottom: 3rem; position: relative; color: var(--text); text-align: center; }
        .section-title::after { content: ''; display: block; width: 60px; height: 3px; background: var(--gold); margin: 15px auto 0; }

        /* --- POTTERY GAME --- */
        #pottery { background: rgba(244, 239, 233, 0.8); border-radius: 20px; margin: 2rem; }
        .game-area { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 500px; width: 100%; margin-top: 2rem; position: relative; min-height: 550px; display: flex; flex-direction: column; justify-content: space-between; }

        .clay-wheel { width: 200px; height: 200px; background: #ddd; border-radius: 50%; margin: 0 auto; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 0 20px rgba(0,0,0,0.2); transition: transform 0.1s linear; flex-shrink: 0; }

        #virtualClay { width: 100px; height: 100px; background: var(--clay); border-radius: 50%; box-shadow: inset -10px -10px 20px rgba(0,0,0,0.3); transition: all 0.3s ease; position: relative; z-index: 2; }

        /* REAL IMAGE CONTAINER */
        #masterpiece { display: none; width: 180px; height: 180px; position: relative; z-index: 10; animation: popIn 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        #masterpiece img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); }

        .party-hat {
            position: absolute; top: -30px; left: 50%; transform: translateX(-30%) rotate(15deg);
            width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 60px solid #ff6b6b; z-index: 20;
        }
        .party-hat::after { content: ''; position: absolute; top: 0; left: -25px; width: 50px; height: 10px; background: #ffd700; border-radius: 50%; transform: translateY(55px); }
        .party-hat::before { content: ''; position: absolute; top: -10px; left: -5px; width: 10px; height: 10px; background: #ffd700; border-radius: 50%; }

        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }

        #gameControls { transition: opacity 0.5s; }
        .meter-container { width: 100%; height: 20px; background: #eee; border-radius: 10px; margin-bottom: 10px; position: relative; overflow: hidden; margin-top: 20px; }
        .meter-label { font-size: 0.8rem; margin-bottom: 5px; display: block; font-weight: bold; color: #666; }
        #rpmBar { height: 100%; width: 0%; background: linear-gradient(90deg, orange 0%, #4CAF50 30%, #4CAF50 80%, red 100%); transition: width 0.1s linear; }
        #progressBar { height: 100%; width: 0%; background: var(--clay); transition: width 0.2s linear; }
        .target-zone { position: absolute; top: 0; left: 30%; width: 50%; height: 100%; background: rgba(0, 255, 0, 0.2); border-left: 2px dashed #4CAF50; border-right: 2px dashed #4CAF50; pointer-events: none; }
        .btn-game { background: var(--clay-dark); color: white; font-size: 1.2rem; padding: 15px 40px; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #8c4e36; transition: transform 0.1s; font-family: 'Noto Serif TC', serif; margin-top: 10px; }
        .btn-game:active { transform: translateY(5px); box-shadow: none; }

        /* Replay Button Style */
        .btn-replay {
            background-color: var(--gold);
            color: #333;
            font-size: 1.1rem;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #b8860b;
            transition: transform 0.1s;
            font-family: 'Noto Serif TC', serif;
            margin-top: 15px;
            display: inline-block;
        }
        .btn-replay:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        #winUI { display: none; margin-top: 20px; animation: slideUp 0.5s ease-out; }
        #winUI h3 { color: var(--red-stamp); font-size: 1.5rem; margin-bottom: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Other Sections */
        #buddhism { background-color: var(--sage); color: white; text-align: center; }
        #buddhism .section-title { color: white; } 
        #buddhism .section-title::after { background: white; }
        .quote-box { font-size: 1.8rem; font-family: 'Noto Serif TC', serif; font-weight: bold; max-width: 800px; min-height: 200px; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .lotus-icon { font-size: 4rem; margin-bottom: 2rem; animation: spinSlow 20s linear infinite; opacity: 0.8; }
        .btn-zen { background: transparent; border: 2px solid white; color: white; padding: 12px 35px; font-family: 'Noto Serif TC', serif; font-size: 1.1rem; margin-top: 30px; cursor: pointer; transition: all 0.3s; border-radius: 50px; }
        .btn-zen:hover { background: white; color: var(--sage); }

        #wooden-fish { background-color: #2a2a2a; color: #eee; text-align: center; }
        #wooden-fish .section-title { color: #eee; }
        .date-card { background: rgba(255,255,255,0.1); padding: 1rem 2rem; border-radius: 15px; margin-bottom: 2rem; border: 1px solid rgba(255,215,0,0.3); display: inline-block; min-width: 300px; }
        .gregorian { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .lunar { font-size: 1.2rem; color: var(--gold); font-family: 'Noto Serif TC', serif; }
        .reminder-bar { background: var(--sage-dark); color: #fff; padding: 10px; border-radius: 50px; margin-bottom: 30px; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 10px; transition: opacity 0.5s; }
        .muyu-container { position: relative; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
        .muyu-container:active { transform: scale(0.95); }
        .muyu-icon { font-size: 8rem; color: var(--wood); filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        .merit-counter { font-size: 1.5rem; margin-top: 20px; font-family: 'Noto Serif TC', serif; }
        .merit-pop { position: absolute; color: var(--gold); font-weight: bold; font-size: 1.5rem; pointer-events: none; animation: floatUp 1s ease-out forwards; }

        #tcm { background: rgba(249, 245, 240, 0.9); }
        .prescription-card { background: #fff; border: 4px double var(--clay-dark); padding: 3rem; width: 100%; max-width: 600px; text-align: center; position: relative; box-shadow: 0 15px 30px rgba(0,0,0,0.1); min-height: 400px; display: flex; flex-direction: column; justify-content: center; }
        .camera-frame { width: 100%; height: 300px; background: #000; margin-bottom: 20px; position: relative; overflow: hidden; border: 2px solid var(--clay); border-radius: 10px; display: none; }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: rgba(0, 255, 0, 0.8); box-shadow: 0 0 15px rgba(0, 255, 0, 1); animation: scanMove 2s linear infinite; z-index: 5; }
        .face-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 250px; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%; z-index: 4; }
        @keyframes scanMove { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .stamp { position: absolute; top: -25px; right: -25px; width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--red-stamp); color: var(--red-stamp); display: flex; align-items: center; justify-content: center; font-weight: 900; transform: rotate(20deg); font-size: 1.2rem; background: rgba(255,255,255,0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2; }
        .tcm-content { opacity: 1; transition: opacity 0.5s; } .tcm-content.fade-out { opacity: 0; }
        .ingredients { list-style: none; margin: 2rem 0; text-align: left; } .ingredients li { padding: 0.8rem 0; border-bottom: 1px dashed #bbb; display: flex; align-items: center; font-size: 1.1rem; } .ingredients i { margin-right: 15px; font-size: 1.2rem; width: 30px; text-align: center; }
        .btn-tcm { background-color: var(--clay-dark); color: white; border: none; padding: 12px 30px; font-size: 1.1rem; border-radius: 5px; cursor: pointer; font-family: 'Noto Serif TC', serif; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; } .btn-tcm:hover { background-color: var(--clay); transform: translateY(-2px); }
        .btn-reset { background-color: #666; margin-top: 10px; }
        .btn-export { background-color: var(--gold); color: #333; border: 1px solid #b8860b; margin-top: 10px; } .btn-export:hover { background-color: #ffd700; }

        #wishes { background: #1a1a1a; color: var(--cream); padding-bottom: 6rem; } #wishes .section-title { color: var(--cream); }
        .message-container { width: 100%; max-width: 900px; margin: 0 auto; }
        .wish-form { background: rgba(255,255,255,0.05); padding: 2rem; border-radius: 10px; margin-bottom: 3rem; display: flex; flex-wrap: wrap; gap: 1rem; border: 1px solid rgba(255,255,255,0.1); }
        .input-group { flex: 1; min-width: 200px; } .wish-form input, .wish-form textarea { width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; border-radius: 5px; font-family: 'Lato', sans-serif; } .wish-form textarea { height: 80px; resize: vertical; }
        .btn-submit { background: var(--gold); color: #1a1a1a; border: none; padding: 10px 25px; font-weight: bold; cursor: pointer; border-radius: 5px; height: fit-content; align-self: flex-end; transition: background 0.3s; } .btn-submit:hover { background: #fff; }
        .wishes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; width: 100%; } .wish-card { background: #2a2a2a; padding: 2rem; position: relative; transition: transform 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-top: 4px solid var(--gold); } .wish-card:hover { transform: translateY(-5px); background: #333; }
        .wish-text { margin-top: 0.5rem; font-size: 1.1rem; line-height: 1.6; min-height: 60px; } .wish-author { margin-top: 1.5rem; text-align: right; font-weight: bold; color: var(--sage); font-size: 1rem; font-family: 'Noto Serif TC', serif; } .wish-date { font-size: 0.7rem; color: #555; text-align: right; margin-top: 5px; }
        footer { padding: 3rem; text-align: center; background: #000; color: #888; font-size: 0.9rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        @keyframes spinSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
    </style>
</head>
<body>

    <canvas id="celebrationCanvas"></canvas>
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="bg-orb orb-3"></div>
    
    <!-- Background Zen Music (Meditation) -->
    <audio id="bgMusic" loop="">
        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=meditation-flute-8763.mp3" type="audio/mpeg">
    </audio>
    
    <!-- *** IMPROVED MUSIC PLAYER *** -->
    <!-- 
         INSTRUCTION: To use your own song:
         1. Put a file named "birthday.mp3" in the same folder as this HTML file.
         2. Change src="..." below to src="birthday.mp3"
         
         Currently using a reliable test sound (Celebration Sound) so you can hear it works.
    -->
    <audio id="birthdaySong" preload="auto">
        <!-- TEST LINK (Royalty Free Music): -->
        <source src="BDAY SONG.mp3" type="audio/mpeg">
    </audio>

    <nav>
        <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#pottery">æ‹‰å¯ (Clay)</a></li>
            <li><a href="#buddhism">ä½›ç³» (Zen)</a></li>
            <li><a href="#wooden-fish">æœ¨é­š (Calendar)</a></li>
            <li><a href="#tcm">æ™ºèƒ½æœ›è¨º (Doctor)</a></li>
            <li><a href="#wishes">ç•™è¨€æ¿ (Board)</a></li>
        </ul>
    </nav>

    <header id="home">
        <!-- *** PLACEHOLDER FOR YOUR UPLOADED IMAGE *** -->
        <!-- Ensure your image is named 'banner.png' and is in the same folder -->
        <img src="Chiikawa2.png" alt="Happy Birthday Teammate" class="banner-img">
        
        <h1>Happy Birthday Lamy!</h1>
        <p>ç¥ä½ ä»Šå¹´ï¼šå¿ƒå¢ƒå¥½ Zenï¼Œä½œå“å¥½å‹ï¼Œèº«é«”å¥½æ‚ï¼<br><span style="font-size: 0.9rem; opacity: 0.8;">(May your mind be Zen, your art be powerful, and your health be great!)</span></p>
        
        <!-- FUNNY THEMED BUTTON -->
        <button class="btn-music-player" id="playSongBtn" onclick="toggleBirthdaySong()">
            <i class="fas fa-praying-hands"></i> å•Ÿå‹•å»¶å¹´ç›Šå£½ BGM (Play Longevity Tune)
        </button>

        <!-- Auto Party Mode Text Removed -->
        <div class="scroll-down" onclick="document.getElementById('pottery').scrollIntoView()"><i class="fas fa-chevron-down"></i></div>
    </header>

    <section id="pottery">
        <h2 class="section-title">ã€é™¶è—å¤§æŒ‘æˆ°ã€‘æ‹‰å¯å‡º Chiikawa!</h2>
        <p style="max-width: 600px; text-align: center; margin-bottom: 1rem;">
            Lamy, å¿«é€Ÿæ’³ "è¸©æ²¹" Keep ä½ç¶ è‰²å€åŸŸ (Easy Mode)ï¼Œ<br>è¦‹è­‰èˆŠæ³¥è®Šèº«åšå¯æ„› Chiikawa é™¶å™¨!
        </p>
        
        <div class="game-area">
            <div class="clay-wheel" id="wheel">
                <div id="virtualClay"></div>
                <div id="masterpiece">
                    <div class="party-hat"></div>
                    <!-- This image source will be replaced by JS when game is won -->
                    <img src="https://thumbnail.imgbin.com/10/1/16/chiikawa-cute-cat-doodle-wyqFKUnf_t.jpg" alt="Chiikawa" id="resultImage">
                </div>
            </div>
            <div id="gameControls">
                <div class="meter-container">
                    <div class="target-zone"></div>
                    <div id="rpmBar"></div>
                </div>
                <span class="meter-label">Wheel Speed (RPM)</span>
                <div class="meter-container" style="height: 10px; margin-top: 15px;">
                    <div id="progressBar"></div>
                </div>
                <span class="meter-label">Creation Progress</span>
                <button class="btn-game" id="kickBtn" onclick="kickWheel()">
                    <i class="fas fa-shoe-prints"></i> è¸©æ²¹ / Kick Wheel
                </button>
            </div>
            <div id="winUI">
                <h3 style="color: var(--red-stamp);">ğŸ‚ Happy Birthday Lamy! ğŸ‚</h3>
                <p>Chiikawa brought a cake for you!</p>
                <!-- SEPARATED REPLAY BUTTON -->
                <button class="btn-replay" onclick="resetGame()">
                    <i class="fas fa-redo"></i> å†ç©ä¸€æ¬¡ (Replay)
                </button>
            </div>
        </div>
    </section>

    <section id="buddhism">
        <i class="fas fa-dharmachakra lotus-icon"></i>
        <h2 class="section-title">ã€ä½›ç³» Wisdomã€‘ä¿æŒ Inner Peace</h2>
        <div class="quote-box" id="quoteDisplay">"æœ¬æ¥ç„¡ä¸€ç‰©ï¼Œä½•è™•æƒ¹å¡µåŸƒã€‚"</div>
        <button class="btn-zen" onclick="newQuote()"><i class="fas fa-random"></i> æŠ½å¥é‡‘å¥ (Get Wisdom)</button>
    </section>

    <section id="wooden-fish">
        <h2 class="section-title">ã€é›»å­æœ¨é­šã€‘ç©åŠŸå¾· &amp; æ—¥æ›†</h2>
        <div class="date-card">
            <div class="gregorian" id="gregorianDate">Loading...</div>
            <!-- FIXED CHINESE CALENDAR ID -->
            <div class="lunar" id="lunarDate"><i class="fas fa-moon"></i> è¾²æ›† è¨ˆç®—ä¸­...</div>
        </div>
        <div class="reminder-bar">
            <i class="fas fa-bell"></i> <span id="reminderText">æº«é¦¨æç¤ºï¼šè¨˜å¾—é£²æ°´ï¼Œä¿æŒæ°´æ½¤ï¼</span>
        </div>
        <div class="muyu-container" onclick="tapWoodenFish(event)">
            <i class="fas fa-fish muyu-icon"></i>
        </div>
        <div class="merit-counter">ç´¯ç©åŠŸå¾· (Total): <span id="meritCount">0</span></div>
    </section>

    <section id="tcm">
        <h2 class="section-title">ã€AI æ™ºèƒ½æœ›è¨ºã€‘ç¥é†«æŠŠè„ˆ</h2>
        <p style="margin-bottom: 2rem;">é†«å¸«ï¼šLamyï¼Œé–‹é¡é ­æœ›ä¸‹æ°£è‰²ï¼Œç„¡é™æ¬¡ä»»ç‡ï¼</p>
        
        <div class="prescription-card" id="tcmResultCard">
            <div class="stamp" id="stampMark" style="display:none;">å¤§å‰<br>Valid</div>
            <div class="camera-frame" id="cameraSection">
                <div class="scan-overlay"></div>
                <div class="face-box"></div>
                <video id="videoFeed" autoplay="" playsinline=""></video>
            </div>
            <div id="tcmContent" class="tcm-content">
                <h3><i class="fas fa-user-md"></i> ç­‰å€™è¨ºæ–·ä¸­...</h3>
                <p style="font-style: italic; margin-top: 10px; color: #666;">(Awaiting diagnosis...)</p>
            </div>
            <div id="btnContainer">
                <button class="btn-tcm" id="btnCamera" onclick="startCamera()"><i class="fas fa-camera"></i> é–‹å•Ÿç¥é†«å¤©çœ¼ (Open Camera)</button>
                <button class="btn-tcm" id="btnScan" onclick="analyzeFace()" style="display: none; background-color: var(--red-stamp);"><i class="fas fa-search"></i> ç«‹å³æœ›è¨º (Analyze)</button>
                <button class="btn-tcm" id="btnManual" onclick="getPrescription(true)" style="margin-top:10px; font-size:0.9rem; background:transparent; color:#999; border:1px solid #ddd;">é¡é ­å£å’—? æ‰‹å‹•æŠ½ç±¤ (Manual Draw)</button>
            </div>
        </div>
    </section>

    <section id="wishes">
        <h2 class="section-title">ã€éšŠå‹ç•™è¨€æ¿ã€‘ç¥ç¦ Wishing Wall</h2>
        <div class="message-container">
            <div class="wish-form">
                <div class="input-group"><input type="text" id="inputName" placeholder="Your Name (ä½ çš„å¤§å)"></div>
                <div class="input-group" style="flex: 2;"><textarea id="inputMsg" placeholder="Leave a birthday message for Lamy..."></textarea></div>
                <button class="btn-submit" onclick="addMessage()">Post Message <i class="fas fa-paper-plane"></i></button>
            </div>
            <div class="wishes-grid" id="wishesGrid"></div>
        </div>
    </section>

    <footer><p>Made with â¤ï¸ &amp; Qi for Lamy. Happy Birthday!</p></footer>

    <script>
        // --- ANIMATION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
            }, { threshold: 0.1 });
            document.querySelectorAll('section').forEach(section => observer.observe(section));
        });

        const canvas = document.getElementById('celebrationCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();

        class Particle {
            constructor(x, y, color, type) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 8 + 4;
                this.speedX = Math.random() * 6 - 3;
                this.speedY = Math.random() * -6 - 3;
                this.gravity = 0.1; this.life = 100; this.type = type;
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.speedY += this.gravity; this.life--; if (this.type === 'confetti') this.rotation = (this.rotation || 0) + 0.1; }
            draw() { ctx.fillStyle = this.color; ctx.beginPath(); if (this.type === 'firework') { ctx.arc(this.x, this.y, this.size / 2, 0, Math.PI * 2); } else { ctx.fillRect(this.x, this.y, this.size, this.size); } ctx.fill(); }
        }
        function handleParticles() { for (let i = 0; i < particles.length; i++) { particles[i].update(); particles[i].draw(); if (particles[i].life <= 0) { particles.splice(i, 1); i--; } } }
        function animateParticles() { ctx.clearRect(0, 0, canvas.width, canvas.height); handleParticles(); requestAnimationFrame(animateParticles); }
        const colors = ['#ff0055', '#00ddff', '#ffff00', '#55ff00', '#d4af37', '#ffffff'];
        function explodeConfetti() { for (let i = 0; i < 100; i++) { particles.push(new Particle(window.innerWidth / 2, window.innerHeight / 1.2, colors[Math.floor(Math.random() * colors.length)], 'confetti')); } }
        function triggerFireworks() { for (let i = 0; i < 5; i++) { let startX = Math.random() * canvas.width; let startY = canvas.height; setTimeout(() => { for (let j = 0; j < 30; j++) { let p = new Particle(startX, startY / 1.5, colors[Math.floor(Math.random() * colors.length)], 'firework'); p.speedY = Math.random() * 10 - 5; p.gravity = 0.05; particles.push(p); } }, i * 200); } }
        animateParticles();
        let fwCount = 0; let fwInterval = setInterval(() => { triggerFireworks(); fwCount++; if(fwCount > 5) clearInterval(fwInterval); }, 800); setTimeout(explodeConfetti, 500);

        // --- APP DATA ---
        const reminders = [
            "æº«é¦¨æç¤ºï¼šè¨˜å¾—é£²æ°´ï¼Œä¿æŒæ°´æ½¤ï¼(Hydrate!)",
            "æº«é¦¨æç¤ºï¼šåè€å’—ï¼Œèµ·èº«ä¼¸å€‹æ‡¶è…°å•¦ï¼(Stretch!)",
            "æº«é¦¨æç¤ºï¼šæ·±å‘¼å¸... å¸æ°£... å‘¼æ°£... (Breathe)",
            "æº«é¦¨æç¤ºï¼šå°çœ¼æ”°å””æ”°ï¼Ÿæœ›ä¸‹é æ™¯é¤Šä¸‹ç¥ã€‚",
            "æº«é¦¨æç¤ºï¼šä»Šæ—¥æœ‰ç„¡ç¬‘éå‘€ï¼Ÿç¬‘ä¸€å€‹å•¦ï¼:)"
        ];

        // UPDATED BUDDHIST QUOTES
        const buddhistQuotes = [
            "æœ¬ä¾†ç„¡ä¸€ç‰©ï¼Œä½•è™•æƒ¹å¡µåŸƒã€‚", "å¿ƒç„¡æ›ç¤™ï¼Œç„¡æ›ç¤™æ•…ï¼Œç„¡æœ‰ææ€–ã€‚", "æ´»åœ¨ç•¶ä¸‹ï¼Œæ—¥æ—¥æ˜¯å¥½æ—¥ã€‚",
            "éš¨ç·£è‡ªåœ¨ï¼Œä¸æ‚²ä¸å–œã€‚", "åšäººæœ€ç·Šè¦ä¿‚é–‹å¿ƒã€‚(TVB é‡‘å¥äº¦æ˜¯ç¦ª)", "å¤§è‚šèƒ½å®¹ï¼Œå®¹å¤©ä¸‹é›£å®¹ä¹‹äº‹ã€‚",
            "Peace comes from within.", "ç·£ä»½åˆ°å’—ï¼Œè‡ªç„¶æœƒæœ‰ï¼Œå””å¥½å¼·æ±‚ã€‚", "ä»Šæ—¥å””çŸ¥è½æ—¥äº‹ï¼Œè½æ—¥å…ˆç®—ï¼Œä»Šæ—¥é£²èŒ¶ã€‚",
            "è©ææœ¬ç„¡æ¨¹ï¼Œæ˜é¡äº¦éå°ã€‚", "å‡¡æ‰€æœ‰ç›¸ï¼Œçš†æ˜¯è™›å¦„ã€‚", "æ‡‰ç„¡æ‰€ä½ï¼Œè€Œç”Ÿå…¶å¿ƒã€‚",
            "ä¸€åˆ‡æœ‰ç‚ºæ³•ï¼Œå¦‚å¤¢å¹»æ³¡å½±ã€‚", "ç…©æƒ±å³è©æï¼ŒOT å³ä¿®è¡Œ (è¬›ç¬‘å’‹)ã€‚", "ä¸€æœŸä¸€æœƒï¼Œçæƒœæ¯ä¸€æ¬¡ç›¸èšã€‚",
            "å¿ƒä¸å‹•ï¼Œäººä¸å‹•ï¼Œé¢¨å‹•è€Œå¿ƒä¸å‹•ã€‚", "å¿ä¸€æ™‚é¢¨å¹³æµªéœï¼Œé€€ä¸€æ­¥æµ·é—Šå¤©ç©ºã€‚",
            "æ”¾ä¸‹å± åˆ€ (Deadline)ï¼Œç«‹åœ°æˆä½›ã€‚", "ä¸–é–“æœ¬ç„¡äº‹ï¼Œåº¸äººè‡ªæ“¾ä¹‹ã€‚",
            "äººè‹¥ç„¡æ±‚å“è‡ªé«˜ï¼ŒCode è‹¥ç„¡ Bug åƒ¹æ›´é«˜ã€‚", "æ˜¯éçµ‚æ—¥æœ‰ï¼Œä¸è½è‡ªç„¶ç„¡ã€‚",
            "å¢ƒéš¨å¿ƒè½‰ï¼Œå¿ƒéš¨å¢ƒè½‰ã€‚", "ä¸€å¿µæ”¾ä¸‹ï¼Œè¬èˆ¬è‡ªåœ¨ã€‚", "è«¸æ³•å› ç·£ç”Ÿï¼Œè«¸æ³•å› ç·£æ»…ã€‚",
            "å³ä½¿è¼¸å’—ï¼Œéƒ½è¦è¼¸å¾—å¥½ç‡ã€‚(To lose with grace is Zen)", "æœ‰ç·£åƒé‡Œèƒ½ç›¸æœƒï¼Œç„¡ç·£å°é¢ä¸ç›¸é€¢ã€‚",
            "é£Ÿå¾—æ˜¯ç¦ï¼Œç“å¾—æ˜¯ç¥¿ï¼Œç„¡ç—…æ˜¯å£½ã€‚", "è«ç”Ÿæ°£ï¼Œäººç”Ÿå°±åƒä¸€å ´æˆ²ã€‚",
            "çŸ¥è¶³å¸¸æ¨‚ï¼Œèƒ½å¿è‡ªå®‰ã€‚", "éœåå¸¸æ€å·±éï¼Œé–’è«‡è«è«–äººéã€‚",
            "æ°£å¤§å‚·èº«ï¼Œä¸å¦‚é£²æ¯å‡æª¸èŒ¶ã€‚"
        ];

        const tcmRecipes = [
            { title: "ã€æ°£å ´å…¨é–‹æ–¹ã€‘The Power Boost", desc: "è¨ºæ–·çµæœï¼šé¢è‰²ç´…æ½¤ä½†æœ‰å°‘å°‘é»‘çœ¼åœˆï¼Œå·¥ä½œå¤ªå¿™ï¼", ingredients: [{ icon: "fa-bolt", color: "#e6b800", text: "<strong>é«˜éº—åƒ:</strong> è£œæ°£ç¬¬ä¸€ã€‚" }, { icon: "fa-fire", color: "#d9534f", text: "<strong>ç´…æ£—:</strong> è£œè¡€æ°£ã€‚" }, { icon: "fa-star", color: "var(--gold)", text: "<strong>é¹¿èŒ¸:</strong> å£¯é™½æ°£ (ç²¾ç¥ä¸Š)ã€‚" }] },
            { title: "ã€ç¾é¡é¤Šå¿ƒæ–¹ã€‘The Beauty Glow", desc: "è¨ºæ–·çµæœï¼šä»™æ°£è¿«äººï¼Œä½†è¦æ³¨æ„è£œæ°´ï¼", ingredients: [{ icon: "fa-spa", color: "#ff99cc", text: "<strong>ç«ç‘°èŠ±:</strong> ç–è‚è§£é¬±ã€‚" }, { icon: "fa-eye", color: "#d9534f", text: "<strong>æå­:</strong> æ˜ç›®é¤Šç¥ã€‚" }, { icon: "fa-gem", color: "#89CFF0", text: "<strong>ç‡•çª©:</strong> æ»‹é™°æ½¤ç‡¥ã€‚" }] },
            { title: "ã€ä½›ç³»æ¸…å¿ƒæ–¹ã€‘The Zen Chill", desc: "è¨ºæ–·çµæœï¼šçœ‰é ­æ·±é–ï¼Œå¯èƒ½è¢« Bug ç…©æ“¾ï¼", ingredients: [{ icon: "fa-leaf", color: "var(--sage-dark)", text: "<strong>ç”˜è‰:</strong> èª¿å’Œç™¾å‘³ã€‚" }, { icon: "fa-mug-hot", color: "#FFFFE0", text: "<strong>èŠèŠ±:</strong> æ¸…ç†±é™ç«ã€‚" }, { icon: "fa-wind", color: "#A9A9A9", text: "<strong>æ·±å‘¼å¸:</strong> å…è²»æœ€æœ‰æ•ˆã€‚" }] },
            { title: "ã€è²¡æºæ»¾æ»¾æ–¹ã€‘The Wealth Magnet", desc: "è¨ºæ–·çµæœï¼šå°å ‚ç™¼å…‰ï¼Œé¡¯ç¤ºå°±å¿«ç™¼é”ï¼", ingredients: [{ icon: "fa-coins", color: "var(--gold)", text: "<strong>é‡‘èŸ¬èŠ±:</strong> æ‹›è²¡é€²å¯¶ã€‚" }, { icon: "fa-lemon", color: "#ffa500", text: "<strong>é™³çš®:</strong> è¶Šé™³è¶Šé¦™ã€‚" }, { icon: "fa-trophy", color: "#FFD700", text: "<strong>è–‘:</strong> åšäº‹å¿«ç‹ æº–ã€‚" }] }
        ];
        let messageBoardData = [
            { name: "Alice", msg: "Happy Birthday Lamy! ç¥ä½ æ–°ä¸€å¹´å‰µæ„çˆ†æ£šï¼Œæ•´é™¶è—æ•´åˆ°é–‹å±•è¦½ï¼" },
            { name: "Terence", msg: "ç”Ÿæ—¥å¿«æ¨‚ Lamyï¼ç¥ä½ åšé‡é †é¢¨é †æ°´ï¼Œæ—©æ”¶å·¥ï¼Œèº«é«”å¥åº·ï¼" },
            { name: "Maggie", msg: "Lamy Happy Birthday! ç¥ä½ é’æ˜¥å¸¸é§ï¼Œæ—¥æ—¥éƒ½å’é–‹å¿ƒï¼" },
            { name: "Brittney", msg: "Yo Lamy! ç”Ÿæ—¥å¤§å¿«æ¨‚ï¼ç¥ä½ ä»Šå¹´æ°£å ´å…¨é–‹ï¼Œé‹æ°£çˆ†ç‡ˆï¼" }
        ];

        // --- HELPER: Convert numbers to Chinese Characters ---
        function toChineseNum(num) {
            const digits = ['é›¶', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
            if (num <= 10) return digits[num];
            if (num < 20) return 'å' + (num % 10 === 0 ? '' : digits[num % 10]);
            if (num < 30) return 'äºŒå' + (num % 10 === 0 ? '' : digits[num % 10]);
            if (num === 30) return 'ä¸‰å';
            return 'ä¸‰åä¸€';
        }

        // --- INIT ---
        window.onload = function() { 
            const today = new Date();
            document.getElementById('gregorianDate').innerText = today.toLocaleDateString('zh-HK', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            
            try {
                // 1. Get the base date string with Chinese month/year but usually Arabic days (e.g. åä¸€æœˆ15)
                const lunarString = new Intl.DateTimeFormat('zh-HK-u-ca-chinese', { month: 'long', day: 'numeric' }).format(today);
                
                // 2. Regex replace numbers with Chinese chars
                const fixedLunar = lunarString.replace(/(\d+)/g, function(match) {
                    return toChineseNum(parseInt(match));
                });

                document.getElementById('lunarDate').innerHTML = `<i class="fas fa-moon"></i> è¾²æ›† ${fixedLunar}`;
            } catch(e) {
                console.log(e);
                document.getElementById('lunarDate').innerHTML = `<i class="fas fa-moon"></i> è¾²æ›† åä¸€æœˆå‰æ—¥`;
            }

            merit = localStorage.getItem('lamyMerit') ? parseInt(localStorage.getItem('lamyMerit')) : 0;
            document.getElementById('meritCount').innerText = merit;
            renderMessages();
            rotateReminders();
        };

        function rotateReminders() {
            const el = document.getElementById('reminderText'); let i = 0;
            setInterval(() => { i = (i + 1) % reminders.length; el.style.opacity = 0; setTimeout(() => { el.innerText = reminders[i]; el.style.opacity = 1; }, 500); }, 5000);
        }

        const bgMusic = document.getElementById('bgMusic');
        const birthdaySong = document.getElementById('birthdaySong');
        const playSongBtn = document.getElementById('playSongBtn');

        // Play Zen music initially
        let playPromise = bgMusic.play();
        if (playPromise !== undefined) { playPromise.catch(error => { document.addEventListener('click', startMusicOnce, { once: true }); }); }
        function startMusicOnce() { 
            // Only play if birthday song isn't playing
            if(birthdaySong.paused) {
                bgMusic.play().catch(e => console.log("Waiting for user interaction")); 
                bgMusic.volume = 0.4; 
            }
        }

        // --- NEW BIRTHDAY SONG LOGIC ---
        function toggleBirthdaySong() {
            try {
                if (birthdaySong.paused) {
                    bgMusic.pause(); // Stop the Zen music
                    birthdaySong.volume = 1.0; // Ensure volume is up
                    
                    const playPromise = birthdaySong.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            // Play started
                            playSongBtn.innerHTML = '<i class="fas fa-pause"></i> æš«åœä¿®ç…‰ (Pause Cultivation)';
                            triggerFireworks();
                        }).catch(error => {
                            console.error("Music play error:", error);
                            alert("æ’­æ”¾å¤±æ•—ï¼Œè«‹é»æ“Šç•«é¢ä¸€ä¸‹å†è©¦ (Play failed, please tap screen once and try again)");
                        });
                    }
                    
                    // When birthday song ends, resume Zen music
                    birthdaySong.onended = function() {
                        playSongBtn.innerHTML = '<i class="fas fa-praying-hands"></i> å•Ÿå‹•å»¶å¹´ç›Šå£½ BGM (Play Longevity Tune)';
                        bgMusic.play();
                    };
                } else {
                    birthdaySong.pause();
                    birthdaySong.currentTime = 0; // Reset to start
                    playSongBtn.innerHTML = '<i class="fas fa-praying-hands"></i> å•Ÿå‹•å»¶å¹´ç›Šå£½ BGM (Play Longevity Tune)';
                    bgMusic.play(); // Resume Zen music
                }
            } catch (err) {
                console.error("Audio Error:", err);
            }
        }

        const quoteDisplay = document.getElementById('quoteDisplay');
        function newQuote() { quoteDisplay.style.opacity = 0; setTimeout(() => { const randomQuote = buddhistQuotes[Math.floor(Math.random() * buddhistQuotes.length)]; quoteDisplay.innerText = `"${randomQuote}"`; quoteDisplay.style.opacity = 1; }, 300); }

        // --- POTTERY GAME ---
        let wheelSpeed = 0, progress = 0, isGameWon = false;
        const rpmBar = document.getElementById('rpmBar'), progressBar = document.getElementById('progressBar'), wheel = document.getElementById('wheel'), clay = document.getElementById('virtualClay'), winMsg = document.getElementById('winUI'), masterpiece = document.getElementById('masterpiece'), gameControls = document.getElementById('gameControls');
        
        // *** CONFIG: Add your 4 Chiikawa images here ***
        const chiikawaPrizeImages = [
            "https://thumbnail.imgbin.com/10/1/16/chiikawa-cute-cat-doodle-wyqFKUnf_t.jpg", // Image 1
            "https://i.pinimg.com/736x/92/a7/26/92a72607cb6df3d620493d40399544d2.jpg", // Image 2
            "https://i.pinimg.com/736x/8d/22/48/8d224818cb058444bf4e598095e15d0c.jpg", // Image 3
            "https://i.pinimg.com/736x/02/38/a7/0238a71f0597342dce4f2334a49e8372.jpg"  // Image 4
        ];

        function kickWheel() { if (isGameWon) return; wheelSpeed += 15; if (wheelSpeed > 100) wheelSpeed = 100; startMusicOnce(); }
        function updateGame() {
            if (isGameWon) return;
            wheelSpeed *= 0.99; if (wheelSpeed < 0) wheelSpeed = 0;
            rpmBar.style.width = wheelSpeed + "%";
            if (wheelSpeed >= 30 && wheelSpeed <= 80) progress += 0.8; else if (wheelSpeed > 80) progress -= 0.2;
            if (progress < 0) progress = 0;
            if (progress >= 100) { progress = 100; winGame(); }
            progressBar.style.width = progress + "%";
            wheel.style.transform = `rotate(${Date.now() / (105 - wheelSpeed)}rad)`;
            if (progress < 100) {
                let h = 100 + progress, w = 100 - (progress * 0.4);
                clay.style.height = h + "px"; clay.style.width = w + "px"; clay.style.borderRadius = "50%";
            }
            requestAnimationFrame(updateGame);
        }

        function winGame() {
            isGameWon = true;
            gameControls.style.display = "none";
            clay.style.display = "none";
            
            // SELECT A RANDOM IMAGE
            const randomImage = chiikawaPrizeImages[Math.floor(Math.random() * chiikawaPrizeImages.length)];
            document.getElementById('resultImage').src = randomImage;

            masterpiece.style.display = "block";
            winMsg.style.display = "block";
            triggerFireworks();
            playWoodenFishSound();
        }

        function resetGame() {
            isGameWon = false; progress = 0; wheelSpeed = 0;
            winMsg.style.display = "none";
            gameControls.style.display = "block";
            masterpiece.style.display = "none";
            clay.style.display = "block";
            clay.style.height = "100px"; clay.style.width = "100px";
            updateGame();
        }
        updateGame();

        // --- SOUNDS ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playWoodenFishSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function playGongSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            osc.type = 'triangle'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2.0);
            osc.start(); osc.stop(audioCtx.currentTime + 2.0);
        }

        function tapWoodenFish(event) { playWoodenFishSound(); merit++; localStorage.setItem('lamyMerit', merit); document.getElementById('meritCount').innerText = merit; const container = document.querySelector('.muyu-container'); const span = document.createElement('span'); span.className = 'merit-pop'; span.innerText = 'åŠŸå¾· +1'; const xOffset = (Math.random() - 0.5) * 50; span.style.left = `calc(50% + ${xOffset}px)`; span.style.top = '20%'; container.appendChild(span); setTimeout(() => { span.remove(); }, 1000); }

        // --- TCM ---
        const tcmContent = document.getElementById('tcmContent'), cameraSection = document.getElementById('cameraSection'), videoFeed = document.getElementById('videoFeed'), btnCamera = document.getElementById('btnCamera'), btnScan = document.getElementById('btnScan'), btnManual = document.getElementById('btnManual'), stampMark = document.getElementById('stampMark'), btnContainer = document.getElementById('btnContainer');
        let stream = null;
        let cameraPermissionDeniedInSession = false;

        async function startCamera() {
            startMusicOnce();
            if (cameraPermissionDeniedInSession) {
                alert("Camera access was previously denied for this session. Please enable camera permissions in your browser settings if you wish to use this feature. Proceeding with manual diagnosis.");
                getPrescription(true);
                return;
            }

            tcmContent.style.display = 'block';
            tcmContent.innerHTML = '<h3><i class="fas fa-spinner fa-spin"></i> ç¥é†«å¤©çœ¼å•Ÿå‹•ä¸­...</h3>';
            stampMark.style.display = 'none';
            
            const oldActionButtons = document.getElementById('actionButtons');
            if (oldActionButtons) oldActionButtons.remove();

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoFeed.srcObject = stream;
                cameraSection.style.display = 'block';
                btnCamera.style.display = 'none';
                btnScan.style.display = 'inline-block';
                btnManual.style.display = 'none';
            } catch (err) {
                console.error("Camera access error:", err);
                cameraPermissionDeniedInSession = true;
                alert("æœªèƒ½é–‹å•Ÿé¡é ­ã€‚å¯èƒ½æ¬Šé™è¢«æ‹’æˆ–æ²’æœ‰é¡é ­ã€‚å·²è½‰ç‚ºæ‰‹å‹•æŠ½ç±¤ã€‚ (Failed to access camera. Permission denied or no camera found. Switching to manual draw.)");
                getPrescription(true);
                cameraSection.style.display = 'none';
                btnCamera.style.display = 'inline-block';
                btnManual.style.display = 'inline-block';
                btnScan.style.display = 'none';
            }
        }

        function analyzeFace() {
            tcmContent.innerHTML = '<h3><i class="fas fa-microchip"></i> AI æ­£åœ¨åˆ†ææ°£è‰²...</h3>';
            videoFeed.pause();
            playWoodenFishSound();
            setTimeout(() => {
                getPrescription(false);
                if(stream) stream.getTracks().forEach(track => track.stop());
                btnScan.style.display = 'none';
            }, 2500);
        }
        
        function getPrescription(isManual) {
            if(isManual) {
                startMusicOnce();
                cameraSection.style.display = 'none';
                btnCamera.style.display = 'inline-block'; 
                btnManual.style.display = 'inline-block';
                btnScan.style.display = 'none';
            }
            tcmContent.classList.add('fade-out');
            setTimeout(() => {
                const recipe = tcmRecipes[Math.floor(Math.random() * tcmRecipes.length)];
                let ingHTML = ""; recipe.ingredients.forEach(ing => { ingHTML += `<li><i class="fas ${ing.icon}" style="color: ${ing.color}"></i> <div>${ing.text}</div></li>`; });
                // *** PRESERVED SPECIFIC TEXT HERE ***
                tcmContent.innerHTML = `<h3><i class="fas fa-file-prescription"></i> ${recipe.title}</h3><p style="font-style: italic; margin-top: 10px; color: #666;">${recipe.desc}</p><ul class="ingredients">${ingHTML}</ul><p style="font-weight: bold; margin-top: 1rem; color: var(--red-stamp);"><i class="fas fa-check-circle"></i> Lamy å°ˆç”¨ (Valid for 1 year)</p>`;
                
                let actionDiv = document.getElementById('actionButtons');
                if(!actionDiv) {
                    actionDiv = document.createElement('div');
                    actionDiv.id = 'actionButtons';
                    btnContainer.appendChild(actionDiv);
                }
                actionDiv.innerHTML = ''; 

                let exportBtn = document.createElement('button'); exportBtn.id = 'btnExport'; exportBtn.className = 'btn-tcm btn-export'; exportBtn.innerHTML = '<i class="fas fa-download"></i> ä¸‹è¼‰è—¥æ–¹ (Save Image)'; exportBtn.onclick = exportTCM;
                let redoBtn = document.createElement('button'); redoBtn.id = 'btnRedo'; redoBtn.className = 'btn-tcm btn-reset'; redoBtn.innerHTML = '<i class="fas fa-redo"></i> å†ç‡å¤šæ¬¡ (Scan Again)'; redoBtn.onclick = resetTCM; 
                
                actionDiv.appendChild(exportBtn);
                actionDiv.appendChild(document.createElement('br'));
                actionDiv.appendChild(redoBtn);
                
                stampMark.style.display = 'flex'; tcmContent.classList.remove('fade-out'); triggerFireworks();
            }, 500);
        }

        function resetTCM() {
            tcmContent.innerHTML = '<h3><i class="fas fa-user-md"></i> ç­‰å€™è¨ºæ–·ä¸­...</h3>';
            stampMark.style.display = 'none';
            cameraSection.style.display = 'none';
            if(stream) {
                stream.getTracks().forEach(track => track.stop());
                videoFeed.srcObject = null;
                stream = null;
            }
            btnCamera.style.display = 'inline-block';
            btnManual.style.display = 'inline-block';
            btnScan.style.display = 'none';
            const actions = document.getElementById('actionButtons');
            if(actions) actions.remove();
        }

        // --- EXPORT FUNCTION ---
        function exportTCM() {
            const card = document.getElementById('tcmResultCard');
            const btnArea = document.getElementById('btnContainer');
            btnArea.style.display = 'none'; 
            
            html2canvas(card, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Lamy_Birthday_Prescription.png';
                link.href = canvas.toDataURL();
                link.click();
                btnArea.style.display = 'block';
            }).catch(err => {
                alert("Export failed. Please try on a modern browser!");
                btnArea.style.display = 'block';
            });
        }

        // --- BOARD ---
        const wishesGrid = document.getElementById('wishesGrid');
        function renderMessages() { wishesGrid.innerHTML = ''; messageBoardData.forEach(msg => { const card = document.createElement('div'); card.className = 'wish-card'; card.innerHTML = `<div class="wish-text">${msg.msg}</div><div class="wish-author">@ ${msg.name}</div><div class="wish-date">From Team</div>`; wishesGrid.prepend(card); }); }
        function addMessage() { const nameInput = document.getElementById('inputName'); const msgInput = document.getElementById('inputMsg'); if (nameInput.value.trim() === "" || msgInput.value.trim() === "") { alert("è«‹è¼¸å…¥ååŒåŸ‹ç¥ç¦èªï¼"); return; } const newMsg = { name: nameInput.value, msg: msgInput.value }; messageBoardData.push(newMsg); renderMessages(); nameInput.value = ""; msgInput.value = ""; playWoodenFishSound(); triggerFireworks(); }
    </script>


</body></html>
